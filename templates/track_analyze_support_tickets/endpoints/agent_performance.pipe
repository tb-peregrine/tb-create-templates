
DESCRIPTION >
    API to track agent performance metrics

NODE agent_performance_node
SQL >
    %
    SELECT
        agent_id,
        count() as tickets_handled,
        countIf(status = 'resolved') as resolved_tickets,
        round(countIf(status = 'resolved') / count() * 100, 2) as resolution_rate,
        round(avg(satisfaction_score), 2) as avg_satisfaction,
        round(avg(if(resolved_at > toDateTime('1970-01-01 00:00:00'), dateDiff('minute', created_at, resolved_at), NULL)), 2) as avg_resolution_time_minutes,
        round(avg(if(first_response_at > toDateTime('1970-01-01 00:00:00'), dateDiff('minute', created_at, first_response_at), NULL)), 2) as avg_response_time_minutes,
        countIf(first_response_at IS NOT NULL AND dateDiff('minute', created_at, first_response_at) <= 
            CASE priority
                WHEN 'high' THEN {{Int(high_priority_response_sla, 30)}}
                WHEN 'medium' THEN {{Int(medium_priority_response_sla, 60)}}
                WHEN 'low' THEN {{Int(low_priority_response_sla, 120)}}
                ELSE {{Int(default_response_sla, 60)}}
            END) as met_response_sla,
        round(countIf(first_response_at IS NOT NULL AND dateDiff('minute', created_at, first_response_at) <= 
            CASE priority
                WHEN 'high' THEN {{Int(high_priority_response_sla, 30)}}
                WHEN 'medium' THEN {{Int(medium_priority_response_sla, 60)}}
                WHEN 'low' THEN {{Int(low_priority_response_sla, 120)}}
                ELSE {{Int(default_response_sla, 60)}}
            END) / count() * 100, 2) as response_sla_percentage
    FROM support_tickets
    WHERE created_at BETWEEN {{DateTime(start_date, '2023-01-01 00:00:00')}} AND {{DateTime(end_date, '2023-12-31 23:59:59')}}
    {% if defined(agent_id) %}
    AND agent_id = {{String(agent_id)}}
    {% end %}
    GROUP BY agent_id
    ORDER BY tickets_handled DESC

TYPE endpoint
        